/*
  Copyright 2010-2017 BusinessCode GmbH, Germany

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
*/
//------------------------------
// Responsible for one-time setup of tools needed for build
// Installs JSDoc, node.js, jaguarjs
// Don't run these tasks directly, run them from root build.gradle as paths need to be relative to root project


//------------------------------
// Tools settings
ext {
  nodeJsDir             = "${rootProject.rootDir}/.gradle/nodejs"
  nodeModulesDir        = "$nodeJsDir/node_modules"
}


//------------------------------------------
// Configure node.js exec and modules local installation process
node {

  version = "12.13.0"

  // If false, it will try to use globally installed node.
  // TODO find a way to dynamically use existing node, if it exists
  download = true

  // Set the work directory for unpacking node itself
  workDir = file(nodeJsDir)
  nodeProjectDir = file(nodeJsDir)
}

import groovy.json.JsonOutput
import groovy.json.JsonSlurper


//******************************************************
// Install for nodeJs: JSDoc, clean-css, jaguarjs theme for jsdoc, sass compiler and clean-css
task bcduiNodeJsTools( type: NpmTask ) {

  outputs.upToDateWhen { file(nodeModulesDir).exists() }

  // We want local node_modules to be below nodejs folder
  execOverrides {
    it.workingDir = file(nodeJsDir)
  }
  doFirst {
    // create a local node_modules folder as we want to keep stuff local
    new File(nodeModulesDir).mkdirs()
    copy {
      from "$sharedBuildFilesRoot/gradle/build_package.json"
      into nodeJsDir
      rename('build_package.json', 'package.json')
    }
  }
  args = ['install']
}


//--------------------------------------------
// Cleanup installed tools
task bcduiClean3rdParty( type: Delete ) {
  group 'bcd-ui/advanced'
  description "Clean 3rdParty tools like nodejs, will trigger fresh install."
  delete nodeJsDir
}


//--------------------------------------------
// Main entry, setting up all build tools
task bcduiToolsOnetimeInit {
  dependsOn bcduiNodeJsTools
}

